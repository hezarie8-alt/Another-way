{% extends "base.html" %}

{% block title %}Ú†Øª Ø¨Ø§ {{ other_user.name }} | ÛŒÙˆÙ†ÛŒ Ù†Øª{% endblock %}

{% block extra_css %}
<style>
    body {
        height: 100vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    
    .navbar {
        flex-shrink: 0;
    }
    
    .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        padding: 0;
    }
    
    .container {
        height: 100%;
        display: flex;
        flex-direction: column;
    }
    
    .chat-page {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
</style>
{% endblock %}

{% block content %}
<div class="chat-page">
    <!-- Search Messages -->
    <div class="search-container" style="flex-shrink: 0;">
        <i class="material-icons search-icon">search</i>
        <input type="text" id="search-messages" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§..." autocomplete="off">
        <div id="search-results"></div>
    </div>

    <!-- Chat Container -->
    <div class="chat-container">
        <!-- Chat Header -->
        <div class="chat-header">
            <a href="{{ url_for('chat.inbox') }}" class="back-button">
                <i class="material-icons">arrow_forward</i>
            </a>
            <div class="other-user-avatar">{{ other_user.name[0] }}</div>
            <div class="other-user-info">
                <div class="other-user-name">{{ other_user.name }}</div>
                <div class="other-user-status">
                    <span class="status-indicator offline" id="user-status"></span>
                    <span id="status-text">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª...</span>
                </div>
            </div>
        </div>

        <!-- Messages Container -->
        <div class="messages-container" id="messages">
            {% if messages %}
                {% for message in messages %}
                <div class="message {% if message.sender_id == current_user_id %}message-sent{% else %}message-received{% endif %}">
                    {% if message.sender_id != current_user_id %}
                    <div class="message-avatar">{{ other_user.name[0] }}</div>
                    {% endif %}
                    
                    {% if message.sender_id == current_user_id %}
                    <div class="message-actions">
                        <button class="edit-message" data-message-id="{{ message.id }}">âœï¸</button>
                        <button class="delete-message" data-message-id="{{ message.id }}">ğŸ—‘ï¸</button>
                    </div>
                    {% endif %}
                    
                    <div class="message-content">
                        <div class="message-text">
                            {{ message.content }}
                            {% if message.edited_at %}
                            <span class="edited-badge">(ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø¯Ù‡)</span>
                            {% endif %}
                        </div>
                        
                        {% if message.file_path %}
                        <div class="message-file">
                            {% if message.file_type in ['png', 'jpg', 'jpeg', 'gif'] %}
                                <img src="{{ url_for('chat.uploaded_file', filename=message.file_path.split('/')[-1]) }}" 
                                     alt="{{ message.file_name }}">
                            {% else %}
                                <span class="file-icon">
                                    {% if message.file_type == 'pdf' %}ğŸ“„
                                    {% elif message.file_type in ['zip', 'rar'] %}ğŸ“¦
                                    {% else %}ğŸ“{% endif %}
                                </span>
                                <a href="{{ url_for('chat.uploaded_file', filename=message.file_path.split('/')[-1]) }}" 
                                   download>
                                    {{ message.file_name }} ({{ (message.file_size / 1024) | round(1) }} KB)
                                </a>
                            {% endif %}
                        </div>
                        {% endif %}
                        
                        <div class="message-time">{{ message.timestamp.strftime('%H:%M') }}</div>
                    </div>
                    <span class="hidden-message-id" data-message-id="{{ message.id }}" style="display:none;"></span>
                </div>
                {% endfor %}
            {% else %}
                <div class="date-separator">Ø´Ø±ÙˆØ¹ Ú¯ÙØªÚ¯Ùˆ</div>
            {% endif %}
            
            <!-- Typing Indicator -->
            <div class="typing-indicator" id="typing-indicator" style="display: none;">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
        </div>

        <!-- Message Input -->
        <div class="message-input-container">
            <!-- File Upload -->
            <div class="file-upload-container">
                <button id="file-button" type="button" title="Ø¶Ù…ÛŒÙ…Ù‡ ÙØ§ÛŒÙ„">ğŸ“</button>
                <input type="file" id="file-input" accept="image/*,.pdf,.doc,.docx,.txt,.zip,.rar">
            </div>
            
            <!-- File Preview -->
            <div id="file-preview"></div>
            
            <!-- Text Input -->
            <form id="message-form" class="message-form">
                <input type="text" 
                       id="message-input" 
                       class="message-input" 
                       placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..." 
                       autocomplete="off"
                       required>
                <button type="submit" class="send-button">
                    <i class="material-icons">send</i>
                </button>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const socket = io();
    window.socket = socket;
    
    const currentUserId = {{ current_user_id }};
    const otherUserId = {{ other_user.id }};
    const otherUserName = "{{ other_user.name }}";
    window.otherUserId = otherUserId;
    
    const roomId = `chat-${Math.min(currentUserId, otherUserId)}-${Math.max(currentUserId, otherUserId)}`;
    const chatMessages = document.getElementById('messages');
    const messageForm = document.getElementById('message-form');
    const messageInput = document.getElementById('message-input');
    const fileInput = document.getElementById('file-input');
    const userStatus = document.getElementById('user-status');
    const statusText = document.getElementById('status-text');
    
    // Join chat room
    socket.emit('join_chat', { other_user_id: otherUserId });
    
    // Check user online status
    fetch(`/api/user_status/${otherUserId}`)
        .then(res => res.json())
        .then(data => {
            if (data.online) {
                userStatus.classList.remove('offline');
                statusText.textContent = 'Ø¢Ù†Ù„Ø§ÛŒÙ†';
            } else {
                userStatus.classList.add('offline');
                statusText.textContent = 'Ø¢ÙÙ„Ø§ÛŒÙ†';
            }
        });
    
    // Scroll to bottom function
    function scrollToBottom() {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    scrollToBottom();
    
    // Send message with file
    messageForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const content = messageInput.value.trim();
        const file = fileInput.files[0];
        
        if (!content && !file) return;
        
        let fileInfo = null;
        
        // Upload file if exists
        if (file) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('other_user_id', otherUserId);
            formData.append('content', content || 'ÙØ§ÛŒÙ„ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯');
            
            try {
                const response = await fetch('/api/send_message_with_file', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                if (data.success) {
                    fileInfo = data.file_info;
                }
            } catch (error) {
                console.error('Error uploading file:', error);
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„');
                return;
            }
        }
        
        // Add message to UI immediately (optimistic UI)
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message message-sent';
        
        let fileHTML = '';
        if (fileInfo) {
            if (['png', 'jpg', 'jpeg', 'gif'].includes(fileInfo.type)) {
                fileHTML = `<div class="message-file"><img src="${fileInfo.url}" alt="${fileInfo.name}"></div>`;
            } else {
                const icon = fileInfo.type === 'pdf' ? 'ğŸ“„' : (fileInfo.type === 'zip' || fileInfo.type === 'rar' ? 'ğŸ“¦' : 'ğŸ“');
                fileHTML = `<div class="message-file">
                    <span class="file-icon">${icon}</span>
                    <a href="${fileInfo.url}" download>${fileInfo.name} (${(fileInfo.size / 1024).toFixed(1)} KB)</a>
                </div>`;
            }
        }
        
        messageDiv.innerHTML = `
            <div class="message-actions">
                <button class="edit-message" data-message-id="temp">âœï¸</button>
                <button class="delete-message" data-message-id="temp">ğŸ—‘ï¸</button>
            </div>
            <div class="message-content">
                <div class="message-text">${content || 'ÙØ§ÛŒÙ„ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯'}</div>
                ${fileHTML}
                <div class="message-time">${new Date().toLocaleTimeString('fa-IR', { hour: '2-digit', minute: '2-digit' })}</div>
            </div>
        `;
        chatMessages.appendChild(messageDiv);
        
        // Send via socket
        socket.emit('send_message', {
            other_user_id: otherUserId,
            content: content || 'ÙØ§ÛŒÙ„ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯',
            file_info: fileInfo
        });
        
        messageInput.value = '';
        fileInput.value = '';
        removeFilePreview();
        scrollToBottom();
    });
    
    // Receive new message
    socket.on('new_message', (data) => {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message message-received';
        
        let fileHTML = '';
        if (data.file) {
            if (['png', 'jpg', 'jpeg', 'gif'].includes(data.file.type)) {
                fileHTML = `<div class="message-file"><img src="${data.file.url}" alt="${data.file.name}"></div>`;
            } else {
                const icon = data.file.type === 'pdf' ? 'ğŸ“„' : (data.file.type === 'zip' || data.file.type === 'rar' ? 'ğŸ“¦' : 'ğŸ“');
                fileHTML = `<div class="message-file">
                    <span class="file-icon">${icon}</span>
                    <a href="${data.file.url}" download>${data.file.name} (${(data.file.size / 1024).toFixed(1)} KB)</a>
                </div>`;
            }
        }
        
        messageDiv.innerHTML = `
            <div class="message-avatar">${otherUserName[0]}</div>
            <div class="message-content">
                <div class="message-text">${data.content}</div>
                ${fileHTML}
                <div class="message-time">${data.timestamp}</div>
            </div>
            <span class="hidden-message-id" data-message-id="${data.message_id}" style="display:none;"></span>
        `;
        chatMessages.appendChild(messageDiv);
        scrollToBottom();
    });
    
    // Handle status updates
    socket.on('status_message', (data) => {
        if (data.type === 'join') {
            userStatus.classList.remove('offline');
            statusText.textContent = 'Ø¢Ù†Ù„Ø§ÛŒÙ†';
        }
    });
    
    // Typing indicator
    let typingTimer;
    messageInput.addEventListener('input', () => {
        clearTimeout(typingTimer);
        socket.emit('typing', { room: roomId });
        typingTimer = setTimeout(() => {
            socket.emit('stop_typing', { room: roomId });
        }, 1000);
    });
    
    socket.on('typing', (data) => {
        if (data.user_id == otherUserId) {
            document.getElementById('typing-indicator').style.display = 'flex';
            scrollToBottom();
        }
    });
    
    socket.on('stop_typing', (data) => {
        if (data.user_id == otherUserId) {
            document.getElementById('typing-indicator').style.display = 'none';
        }
    });
});
</script>
{% endblock %}